<!--
@license
(C) Copyright Nuxeo Corp. (http://nuxeo.com/)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../nuxeo-elements/nuxeo-element.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../paper-listbox/paper-listbox.html">
<link rel="import" href="../../paper-menu-button/paper-menu-button.html">

<dom-module id="nuxeo-actions-menu">
  <template>
    <style>
      :host, #main {
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      [hidden] {
        display: none !important;
      }

      #reparent, #reparent > * {
        width: 0;
        height: 0;
        overflow: hidden;
      }

      #slot::slotted(*), /* chrome, safari */
      #main::slotted(*) { /* firefox, edge */
        @apply --nuxeo-actions-menu-main;
      }

      #dropdown::slotted(*), /* chrome, safari */
      paper-listbox::slotted(*) { /* firefox, edge */
        outline: none;
        user-select: none;
        @apply --nuxeo-actions-menu-dropdown;
      }

      paper-menu-button {
        --paper-menu-button: {
          padding: 0;
        }
      }

      paper-listbox {
        @apply --layout-vertical;
      }
    </style>
    
    <div id="main">
      <slot id="slot"></slot>
    </div>
    <div id="reparent"></div>
    <paper-menu-button id="dropdownButton" close-on-activate no-overlap horizontal-align="right">
      <paper-icon-button icon="icons:more-vert" slot="dropdown-trigger" alt="dropdown"></paper-icon-button>
      <paper-listbox slot="dropdown-content">
        <slot id="dropdown" name="dropdown"></slot>
      </paper-listbox>
    </paper-menu-button>

  </template>

  <script>
    {
      /**
       * A responsive menu that only displays elements fitting the available space. Remaining elements will be placed
       * in a dropdown menu.
       *
       * Example:
       *
       *     <nuxeo-actions-menu>
       *       <nuxeo-add-to-collection-button document="[[document]]"></nuxeo-add-to-collection-button>
       *       <nuxeo-preview-button document="[[document]]"></nuxeo-preview-button>
       *       <nuxeo-favorites-toggle-button document="[[document]]"></nuxeo-favorites-toggle-button>
       *     </nuxeo-actions-menu>
       *
       * @appliesMixin Polymer.IronResizableBehavior
       * @memberof Nuxeo
       * @demo demo/nuxeo-actions-menu/index.html
       */
      class ActionsMenu extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Nuxeo.Element) {

        static get is() {
          return 'nuxeo-actions-menu';
        }

        connectedCallback() {
          super.connectedCallback();
          this._observer = new Polymer.FlattenedNodesObserver(this, ({addedNodes, removedNodes}) => {
            if (addedNodes.length > 0 || removedNodes.length > 0) {
              this._layout();
            }
          });
          this.addEventListener('iron-resize', this._layout);
          this.addEventListener('dom-change', this._layout);
          this.addEventListener('iron-overlay-opened', this._reparent);
        }

        disconnectedCallback() {
          super.disconnectedCallback();
          this._observer.disconnect();
          this.removeEventListener('iron-resize', this._layout);
          this.removeEventListener('dom-change', this._layout);
          this.removeEventListener('iron-overlay-opened', this._reparent);
        }

        ready() {
          super.ready();
        }

        get contentWidth() {
          return this._getMenuElements()
            .reduce((sum, current) => sum + current.clientWidth, this.$.dropdownButton.clientWidth);
        }

        _reparent(e) {
          const src = e.composedPath()[0];
          if ((src.tagName === 'NUXEO-DIALOG' || src.tagName === 'PAPER-DIALOG') && e.target.slot === 'dropdown') {
            const parent = e.target.parentElement;
            const sibling = e.target.nextElementSibling;
            const action = e.target;
            /**
             * XXX: Instead of reparenting dialogs, this handler reparents the actions that trigger dialogs instead, to
             * prevent issues with stacking contexts. The goal is threefold:
             *  1) to prevent the backdrop from overlaping the dialog
             *  2) to prevent the dialog from disappearing when the dropdown is closed
             *  3) to preserve the dialogs inside the actions, which might need to be accessible for custom logics
             */
            Polymer.Async.idlePeriod.run(() => {
              this.$.reparent.appendChild(action);
              action._actionsMenuReparent = action._actionsMenuReparent || (() => parent.insertBefore(action, sibling));
              action.addEventListener('iron-overlay-closed', action._actionsMenuReparent);
            });
          }
        }

        _getMenuElements() {
          return this.$.slot.assignedNodes({flatten: true}).filter((node) => node.nodeType === Node.ELEMENT_NODE);
        }

        _getDropdownElements() {
          return this.$.dropdown.assignedNodes({flatten: true}).filter((node) => node.nodeType === Node.ELEMENT_NODE);
        }

        _moveToMenu(el) {
          el.slot = '';
          el.removeAttribute('show-label');
        }

        _moveToDropdown(el) {
          el.slot = 'dropdown';
          el.setAttribute('show-label', '');
        }

        _layout(e) {
          if (e && e.composedPath().find((el) => el.id === 'reparent' || el.id === 'dropdownButton')) {
            return; // skip events from within reparented actions
          }
          this.__layoutDebouncer = Polymer.Debouncer.debounce(
            this.__layoutDebouncer, Polymer.Async.microTask,
            () => {
              let els = this._getDropdownElements();
              /**
               * XXX: We're using this.contentWidth instead of this.scrollWidth because it takes too much time to be
               * updated on polyfilled browsers (Firex and Edge), leading to an empty menu if there's a single element
               * that doesn't fit on the menu.
               */
              while (els.length && this.contentWidth <= this.clientWidth) {
                this._moveToMenu(els.shift());
              }
              // let's move any element in the menu to the "dropdown" slot if it doesn't fit
              els = this._getMenuElements();
              while (els.length && this.contentWidth > this.clientWidth) {
                this._moveToDropdown(els.pop());
              }
              this.$.dropdownButton.hidden = !this._getDropdownElements().length;
            },
          );
        }
      }

      customElements.define(ActionsMenu.is, ActionsMenu);
      Nuxeo.ActionsMenu = ActionsMenu;
    }
  </script>
</dom-module>
